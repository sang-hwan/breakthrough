# Technical Trading Bot Backtesting Framework

이 프로젝트는 기술적 트레이딩 봇의 백테스트를 위한 통합 프레임워크로, 데이터 수집, 동적 파라미터 관리, 백테스트 실행, 리스크 관리, 거래 전략, 성과 분석 및 로그 관리를 포함합니다.  
**개발 환경에서는 백테스트만 진행**하며, 운영 단계, 실거래 트레이딩, 포워드 테스트는 고려하지 않습니다.

---

## 파일별 분석 및 개선/보완점

### **backtesting**

#### **backtester.py**

- **클래스 및 주요 메소드:**
  - **`Backtester` 클래스**
    - `__init__`: 심볼, 계좌 크기, 수수료/슬리피지, HMM 모델, 리밸런싱 등 초기 설정.
    - `load_data`: 데이터베이스에서 단기/장기 OHLCV 데이터를 불러오며, 추가 타임프레임(Extra) 데이터도 로드.
    - `apply_indicators`: SMA, RSI, MACD 등의 기술적 인디케이터를 계산하여 데이터프레임에 추가.
    - `update_hmm_regime`: HMM 모델을 활용해 시장 레짐을 예측하고, 필요 시 재학습.
    - `update_short_dataframe`: 단기 데이터프레임에 인디케이터와 시장 레짐 정보를 결합.
    - `handle_walk_forward_window`: 워크 포워드 기간 종료 시 미체결 포지션을 청산.
    - `process_bullish_entry` / `process_bearish_exit` / `process_sideways_trade`: 각 시장 상황에 따른 거래 신호 처리(신규 진입, 스케일인, 청산 등).
    - `update_positions`: 포지션의 최고가 업데이트 및 트레일링 스탑 조정.
    - `finalize_all_positions`: 백테스트 종료 시 모든 포지션 최종 청산.
    - `monitor_orders`: 가격 변동 감지 시 추가 로그 출력.
    - `run_backtest`: 전체 백테스트 루프 실행(데이터 순회, 신호 발생, 리밸런싱, 홀드아웃 처리 등).
- **로직 개요:**
  - 여러 타임프레임의 데이터를 결합하여 인디케이터와 HMM 기반의 시장 레짐 분석을 수행하고, 이에 따라 다양한 거래 신호(진입, 청산, 스케일인 등)를 처리하며 계좌 및 포지션 상태를 업데이트합니다.
- **개선 및 보완점:**
  - **HMM 모델 개선:** 피처 선택 및 재학습 임계값 조정을 통해 시장 레짐 예측의 정확도를 높일 수 있습니다.
  - **워크 포워드 로직 최적화:** 백테스트 루프 내 데이터 슬라이싱 및 반복문 성능 개선(예: 벡터화 적용)으로 실행 시간을 단축할 수 있습니다.
  - **신호 처리 정밀도 강화:** 각 거래 신호(진입/청산, 스케일인)의 조건을 세분화하여 더 정밀한 거래 타이밍을 도출할 수 있습니다.

---

#### **optimizer.py**

- **클래스 및 주요 메소드:**
  - **`DynamicParameterOptimizer` 클래스**
    - `objective`: 기본 파라미터와 후보 파라미터를 병합하여 백테스트 성과(Training, Testing, Holdout ROI 등)를 평가하고, 오버피팅 및 홀드아웃 페널티를 반영한 목적 함수를 정의.
    - `optimize`: Optuna를 활용해 여러 트라이얼 수행 후 최적의 파라미터를 도출.
- **로직 개요:**
  - 다양한 자산과 스플릿에 대해 백테스트를 실행하고, 평가 지표(ROI, 오버피팅 페널티 등)를 통해 최적의 파라미터 세트를 선택합니다.
- **개선 및 보완점:**
  - **평가지표 확대:** 최대 낙폭, 연속 손실 등 추가 성과 및 리스크 지표를 목적 함수에 반영하여 보다 정밀한 최적화를 수행할 수 있습니다.
  - **파라미터 병합 전략 보완:** 기본 값과 최적화 결과의 단순 평균 외에 가중 평균 또는 다중 기준 결합 방식을 도입해 파라미터 안정성을 높일 수 있습니다.

---

#### **performance.py**

- **주요 함수:**
  - `calculate_monthly_performance`: 월별 ROI 및 거래 건수를 계산.
  - `calculate_overall_performance`: 누적 수익률, 연간 수익률, 변동성, 샤프/소르티노/칼마 지수, 최대 낙폭 등 종합 성과 지표 계산.
  - `compute_performance`: 전체 성과 지표와 월별 성과를 통합하여 반환.
- **로직 개요:**
  - 거래 내역 데이터를 바탕으로 다양한 성과 지표를 산출해 백테스트 결과를 평가합니다.
- **개선 및 보완점:**
  - **연산 최적화:** 벡터화 연산 및 캐싱 기법 도입으로 계산 속도 개선.
  - **추가 지표 도입:** 예를 들어, 거래 빈도, 연속 승/패 횟수 등 추가 통계 지표를 포함시켜 성과 분석을 보완할 수 있습니다.

---

### **data_collection**

#### **db_config.py**

- **로직 개요:**
  - `.env` 파일에서 데이터베이스 관련 환경 변수를 로드하여 `DATABASE` 딕셔너리를 구성합니다.
- **개선 및 보완점:**
  - **환경 변수 검증:** 필수 변수 누락 시 경고 및 기본값 설정 로직 추가.

---

#### **db_manager.py**

- **주요 함수:**
  - `insert_on_conflict`: 중복 데이터 삽입 시 타임스탬프 기준으로 충돌 방지.
  - `insert_ohlcv_records`: OHLCV 데이터를 청크 단위로 데이터베이스에 저장.
  - `fetch_ohlcv_records`: 지정 기간 내의 OHLCV 데이터를 쿼리하여 DataFrame으로 반환.
- **로직 개요:**
  - SQLAlchemy와 psycopg2를 이용해 PostgreSQL과의 데이터 입출력을 관리합니다.
- **개선 및 보완점:**
  - **에러 핸들링 강화:** 데이터 삽입/조회 시 발생할 수 있는 예외에 대해 더 상세한 로그와 복구 로직 추가.
  - **보안 강화:** 쿼리 파라미터 바인딩 등으로 SQL 인젝션 방지 조치 적용.

---

#### **ohlcv_fetcher.py**

- **주요 함수:**
  - `fetch_historical_ohlcv_data`: ccxt를 사용해 지정 심볼 및 타임프레임의 과거 OHLCV 데이터를 수집.
  - `fetch_latest_ohlcv_data`: 최신 OHLCV 데이터를 수집.
  - `get_top_market_cap_symbols`: 거래량 등을 기준으로 상위 심볼을 선별하며, 데이터 가용성을 확인.
- **로직 개요:**
  - 암호화폐 거래소 API와 연동하여 OHLCV 데이터를 수집하고, DataFrame으로 변환합니다.
- **개선 및 보완점:**
  - **재시도 로직 보완:** 최대 재시도 횟수 및 지연 시간을 세분화하여 네트워크 에러에 대한 복원력 강화.
  - **데이터 정합성 체크:** 수집된 데이터의 이상치나 누락된 값을 자동으로 보정하는 전처리 추가.

---

#### **ohlcv_pipeline.py**

- **주요 함수:**
  - `collect_and_store_ohlcv_data`: 심볼과 타임프레임에 따라 데이터를 수집한 후, 데이터베이스에 저장하는 파이프라인을 구성.
- **로직 개요:**
  - 각 심볼/타임프레임에 대해 데이터 수집 및 저장을 순차적으로 실행하며, 로그를 통해 진행 상황을 모니터링합니다.
- **개선 및 보완점:**
  - **병렬 처리 도입:** 심볼/타임프레임별 데이터 수집을 병렬화하여 전체 실행 시간을 단축.
  - **에러 로깅 개선:** 각 단계에서 발생하는 에러에 대한 상세 로그 및 재시도 로직 보완.

---

### **dynamic_parameters**

#### **dynamic_param_manager.py**

- **클래스 및 주요 메소드:**
  - **`DynamicParamManager` 클래스 (싱글턴)**
    - `get_default_params`: 기본 파라미터 딕셔너리 반환.
    - `update_dynamic_params`: 시장 데이터(변동성, 추세, 거래량 등)를 반영하여 동적으로 파라미터 업데이트.
    - `merge_params`: 최적화 결과와 기본 파라미터를 병합(숫자형은 단순 평균 적용).
- **로직 개요:**
  - 전체 시스템에서 일관된 파라미터 사용을 보장하고, 상황에 따라 파라미터를 동적으로 조정합니다.
- **개선 및 보완점:**
  - **파라미터 병합 로직 개선:** 단순 평균 대신 가중 평균 또는 최적화 결과의 신뢰도를 반영한 병합 알고리즘 도입.
  - **상황별 세분화:** 시장 변동성, 거래량 등 추가 인자를 활용해 더 정밀한 동적 업데이트 로직 구현.

---

### **logs**

#### **final_report.py**

- **주요 함수:**
  - `generate_final_report`: 백테스트 성과 데이터를 받아 사람이 읽기 좋은 리포트 형식으로 로그에 출력.
- **로직 개요:**
  - 전체 성과 및 월별 성과 지표를 정리하여 최종 백테스트 결과 리포트를 생성합니다.
- **개선 및 보완점:**
  - **리포트 커스터마이징:** 사용자 설정에 따른 리포트 포맷 옵션(예: CSV, HTML) 추가.
  - **추가 지표 표시:** 주요 성과 지표 외에도, 거래 빈도나 연속 승/패 등의 추가 통계 정보를 포함.

---

#### **logger_config.py**

- **클래스 및 함수:**
  - `LineRotatingFileHandler`: 라인 수 기준으로 로그 파일을 회전하는 커스텀 핸들러.
  - `get_global_file_handler`: 전역 파일 핸들러를 생성 및 반환.
  - `setup_logger`: 모듈 이름 기반 로거를 설정하고, 콘솔 및 파일 핸들러를 추가.
- **로직 개요:**
  - 프로젝트 전반에서 일관된 로그 기록 및 파일 회전을 지원하여 디버깅과 운영 로그 관리를 용이하게 합니다.
- **개선 및 보완점:**
  - **비동기 로깅:** 고성능 환경을 위해 비동기 로깅 또는 별도 쓰레드 기반 로깅 지원 고려.
  - **로그 포맷 확장:** 모듈별 상세 설정 옵션을 추가해 로그 포맷과 레벨을 유연하게 조정할 수 있도록 개선.

---

#### **logging_util.py**

- **클래스 및 주요 메소드:**
  - **`EventLogger` (alias: `LoggingUtil`) 클래스**
    - `log_event`: 개별 이벤트 로그 기록 및 내부 카운트 증가.
    - `log_summary`: 일정 횟수 이상 이벤트 발생 시 요약 로그를 출력.
- **로직 개요:**
  - 이벤트 기반 로그 집계 기능을 제공하여, 반복 이벤트 발생 시 요약 정보를 통해 로그를 간결하게 관리합니다.
- **개선 및 보완점:**
  - **요약 통계 강화:** 이벤트 집계 시, 발생 빈도 및 평균 처리 시간 등 추가 통계 정보를 포함하도록 개선.
  - **유연한 임계치 설정:** 모듈별로 임계치를 동적으로 조정할 수 있는 옵션 추가.

---

### **trading**

#### **account.py**

- **클래스 및 주요 메소드:**
  - **`Account` 클래스**
    - `add_position` / `remove_position`: 포지션 관리.
    - `get_used_balance`, `get_available_balance`: 사용된 잔고와 가용 잔고 계산.
    - `update_after_trade`: 거래 체결 후 계좌 잔고 업데이트.
    - `convert_to_stablecoin`, `convert_to_spot`: 자산 간 전환 기능.
- **로직 개요:**
  - 거래 실행에 따른 계좌 상태(현물 및 스테이블코인 잔고)와 포지션 변화를 관리합니다.
- **개선 및 보완점:**
  - **상세 계좌 상태 추적:** 거래별 상세 로그와 잔고 변동 내역을 더 정밀하게 기록하여 디버깅에 활용.
  - **전환 수수료 최적화:** 전환 로직에 추가 검증 및 경고 메시지 보완.

---

#### **asset_manager.py**

- **클래스 및 주요 메소드:**
  - **`AssetManager` 클래스**
    - `rebalance`: 시장 레짐에 따라 현물과 스테이블코인 간 자산 배분을 조정.
- **로직 개요:**
  - 최소 배분 차이 및 최소 리밸런싱 간격 조건에 따라 계좌 자산 전환을 실행합니다.
- **개선 및 보완점:**
  - **동적 리밸런싱:** 시장 변동성, 거래량 등 추가 인자를 활용해 리밸런싱 기준을 동적으로 조정.
  - **리밸런싱 효율성:** 자산 전환 시 불필요한 전환을 최소화하도록 조건 개선.

---

#### **ensemble_manager.py**

- **클래스 및 주요 메소드:**
  - **`EnsembleManager` 클래스**
    - `get_final_signal`: 여러 거래 전략(기본, 추세추종, 돌파, 역추세, 고주파)의 신호를 가중치 기반으로 집계 및 데바운싱.
    - `update_strategy_weights`: 실시간 성과에 따라 전략별 가중치를 조정.
- **로직 개요:**
  - 개별 전략의 신호를 종합하여 최종 거래 신호를 도출하고, 신호 변경 빈도를 관리합니다.
- **개선 및 보완점:**
  - **실시간 성과 반영:** 전략별 과거 성과 데이터를 실시간으로 반영해 가중치 조정 알고리즘을 정교화.
  - **추가 전략 도입:** 필요 시 새로운 전략 모듈 추가 및 기존 전략 간 상호 보완 효과 강화.

---

#### **indicators.py**

- **주요 함수:**
  - `compute_sma`: 단순 이동평균(SMA) 계산.
  - `compute_macd`: MACD 및 관련 지표 계산.
  - `compute_rsi`: RSI 계산.
  - `compute_bollinger_bands`: Bollinger Bands 및 관련 지표 계산.
- **로직 개요:**
  - ta 라이브러리를 활용해 다양한 기술적 인디케이터를 DataFrame에 추가합니다.
- **개선 및 보완점:**
  - **계산 최적화:** 동일 데이터에 대해 반복 계산을 피하기 위해 캐싱 또는 벡터화 연산 도입.
  - **에러 처리 강화:** 인디케이터 계산 시 데이터 결측치 처리 및 예외 상황에 대한 대체 로직 추가.

---

#### **positions.py**

- **클래스 및 주요 메소드:**
  - **`TradePosition` 클래스**
    - `add_execution`: 거래 실행 추가.
    - `get_total_size`, `get_average_entry_price`: 포지션 크기 및 평균 진입가 계산.
    - `partial_close_execution`: 부분 청산 시 포지션 일부 청산 처리.
- **로직 개요:**
  - 하나의 포지션 내에서 여러 거래 실행 내역을 관리하고, 분할 진입 및 부분 청산 로직을 지원합니다.
- **개선 및 보완점:**
  - **부분 청산 로직 보완:** 최소 주문 수량 미만 처리 및 잔여 포지션 관리 로직 개선.
  - **포지션 상태 추적 강화:** 포지션별 상세 거래 이력과 리스크 노출을 추가로 기록.

---

#### **risk_manager.py**

- **클래스 및 주요 메소드:**
  - **`RiskManager` 클래스 (정적 메소드 모음)**
    - `compute_position_size`: 가용 잔고, 위험 비율, 진입가, 스탑로스, 변동성 등을 반영한 포지션 사이즈 계산.
    - `allocate_position_splits`: 분할 진입 비율(동일, 피라미드 방식 등) 산출.
    - `attempt_scale_in_position`: 가격 조건 만족 시 추가 진입(스케일인) 실행.
    - `compute_risk_parameters_by_regime`: 시장 레짐 및 유동성에 따라 리스크 파라미터를 조정.
    - 기타 로그 집계 및 변화 감지 기능 제공.
- **로직 개요:**
  - 거래 리스크 관리와 관련된 모든 계산 및 전략(포지션 사이징, 스케일인 등)을 중앙집중식으로 관리합니다.
- **개선 및 보완점:**
  - **정교한 리스크 계산:** 추가 통계 지표(예: 최대 낙폭, 연속 손실 등)를 반영하여 포지션 사이징 공식 개선.
  - **스케일인 조건 최적화:** 스케일인 타이밍 및 분할 진입 비율을 보다 유연하게 조정할 수 있도록 로직 보완.

---

#### **strategies.py**

- **클래스 및 주요 메소드:**
  - **`TradingStrategies` 클래스**
    - `_get_candle_pattern_signal`: 캔들 패턴 분석을 통한 신호 도출.
    - `_get_sma_rsi_signal`: SMA와 RSI를 이용한 거래 신호 판단.
    - `_get_bb_signal`: Bollinger Bands 기반 신호 판단.
    - `select_strategy`: 여러 보조 신호를 종합하여 최종 거래 신호 결정.
    - `trend_following_strategy`: 단순 추세추종 신호 생성.
    - `breakout_strategy`: 최근 고점 돌파 여부를 판단해 진입 신호 생성.
    - `counter_trend_strategy`: RSI 기반 역추세 신호 판단.
    - `high_frequency_strategy`: 단기 가격 변동에 따른 고주파 신호 생성.
- **로직 개요:**
  - 다양한 거래 전략을 구현하여, 시장 데이터 분석을 통해 개별 신호를 생성하고 데바운싱 및 집계 기능으로 최종 신호를 도출합니다.
- **개선 및 보완점:**
  - **전략 다양성 확대:** 추가 기술적 지표나 머신러닝 모델을 접목해 전략의 정밀도를 높일 수 있습니다.
  - **신호 데바운싱 개선:** 신호 변경 빈도 조절 및 임계치 조정으로 불필요한 신호 변동을 줄이는 보완 로직 도입.

---

#### **trade_manager.py**

- **클래스 및 주요 메소드:**
  - **`TradeManager` 클래스**
    - `calculate_atr_stop_loss`: ATR 및 동적 승수를 이용해 스탑로스 가격을 계산.
    - `adjust_trailing_stop`: 상승에 따른 트레일링 스탑 가격 조정.
    - `set_fixed_take_profit`: 고정 테이크 프로핏 목표 설정.
    - `should_exit_trend`: 최근 가격 추세에 따른 청산 여부 결정.
    - `calculate_partial_exit_targets`: 부분 청산 목표 가격 및 비율 산출.
    - `compute_atr`: ATR 값 계산.
    - `calculate_dynamic_stop_and_take`: 리스크 파라미터를 반영한 동적 스탑로스 및 테이크 프로핏 계산.
- **로직 개요:**
  - 거래 실행 및 종료 시점 결정, 리스크 관리 및 청산 타이밍을 위한 다양한 계산 로직을 제공합니다.
- **개선 및 보완점:**
  - **연산 효율화:** 계산 로직의 벡터화 및 캐싱 적용을 통해 백테스트 성능을 향상.
  - **예외 처리 강화:** 인덱스 누락이나 데이터 오류에 대비한 추가 검증 및 예외 처리 로직 보완.

---

### **root-level 파일**

#### **.env**

- **로직 개요:**
  - 데이터베이스, 로깅 등의 환경 변수를 설정합니다.
- **개선 및 보완점:**
  - **보안 강화:** 민감 정보 암호화 또는 별도 비밀 관리 시스템 연동 고려.

---

#### **requirements.txt**

- **로직 개요:**
  - 프로젝트에서 사용하는 Python 패키지 목록을 명시합니다.
- **개선 및 보완점:**
  - **버전 고정:** 패키지 버전을 명시하여 환경 재현성을 높일 수 있습니다.

---

#### **run_strategy_performance.py**

- **주요 함수 및 로직:**
  - 로그 파일 초기화 및 기존 로그 핸들러 재설정.
  - 동적 파라미터 최적화 실행(Optuna 기반) 후, 최적의 파라미터를 도출.
  - 각 심볼에 대해 데이터 로드, 백테스트 실행, 거래 내역 및 성과 리포트 생성.
- **로직 개요:**
  - 전체 백테스트 및 최적화 파이프라인의 엔트리 포인트로, 각 심볼별로 백테스트를 실행하고 성과를 분석합니다.
- **개선 및 보완점:**
  - **모듈화 강화:** 각 단계(데이터 로드, 백테스트 실행, 리포트 생성)를 별도 함수로 분리하여 코드 가독성 및 유지보수성을 향상.
  - **로깅 세분화:** 실행 단계별로 더 상세한 로그를 남겨 디버깅 및 결과 분석을 용이하게 개선.

---

## 결론

이 프로젝트는 데이터 수집부터 동적 파라미터 최적화, 백테스트 실행, 리스크 관리, 거래 전략 및 성과 분석까지 전 과정을 지원하는 통합 프레임워크입니다.  
각 파일별로 제시한 개선 및 보완점을 반영하여, 백테스트에서 매월 2% 이상의 ROI 달성을 목표로 지속적인 개선을 진행할 수 있습니다.  
개발 환경에서는 안정적인 백테스트 분석에 초점을 맞추며, 운영 단계는 고려하지 않습니다.
